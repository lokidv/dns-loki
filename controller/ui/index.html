<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNS+SNI Control UI</title>
  <style>
    :root{
      --bg:#0b1020; --surface:#121833; --surface-2:#0f1530; --border:#2b355e;
      --text:#e7ecff; --muted:#a8b3d0; --brand:#5c7cff; --ok:#67e08c; --warn:#ffcf66; --err:#ff7b7b;
    }
    *{ box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:var(--bg); color:var(--text); }
    .container{ max-width:1200px; margin: 24px auto; padding: 0 16px; overflow-x:hidden; }
    h1{ margin: 0 0 16px 0; font-size: 22px; display:flex; align-items:center; gap:10px; }
    h2{ margin: 0 0 12px 0; font-size: 18px; }

    .row { display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:16px; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: span 12; }
    @media (max-width: 900px){ .col-6, .col-4, .col-8 { grid-column: span 12; } }
    .card { background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:1px solid var(--border); border-radius:12px; padding:16px; backdrop-filter: blur(6px); overflow:hidden; }
    input, button, select, textarea { background:var(--surface-2); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    button { cursor:pointer; transition:.2s; }
    button:hover{ border-color: var(--brand); box-shadow: 0 0 0 2px rgba(92,124,255,.15) inset; }
    .btn-primary{ background: linear-gradient(180deg, #6d86ff, #4864ff); border-color: #4864ff; color:#fff; }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--border); padding:8px 10px; font-size: 14px; word-break: normal; }
    th{ color:var(--muted); font-weight:600; text-align:right; background: rgba(255,255,255,0.02); }
    code { background:var(--surface-2); padding:2px 6px; border-radius:6px; }
    .muted { color:var(--muted); font-size:13px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; background:#1a2659; margin-left:6px; font-size:12px; }
    .status{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; font-size:12px; }
    .status.ok{ background: rgba(103,224,140,.12); color: var(--ok); border:1px solid rgba(103,224,140,.35) }
    .status.warn{ background: rgba(255,207,102,.12); color: var(--warn); border:1px solid rgba(255,207,102,.35) }
    .status.err{ background: rgba(255,123,123,.12); color: var(--err); border:1px solid rgba(255,123,123,.35) }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:700px){ .grid-2{ grid-template-columns:1fr; } }
    .right { text-align:right; }
    .left { text-align:left; }
    .section-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    .input-inline{ display:flex; gap:8px; }
    .divider{ height:1px; background: var(--border); margin: 10px 0; }
    .count{ font-size:12px; color:var(--muted); }
    .details{ background: var(--surface-2); border:1px solid var(--border); border-radius:10px; padding:10px; max-width:100%; overflow:hidden; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; font-size:13px; }
    .kv b{ color:var(--muted); font-weight:600; }
    /* Prevent horizontal overflow and improve tables */
    code{ overflow-wrap:anywhere; word-break:break-word; direction:ltr; }
    /* avoid awkward wraps on chips/buttons/status */
    .pill, .status, button { white-space: nowrap; }
    .pill, .status{ display:inline-flex; align-items:center; }
    .cell-actions .input-inline{ flex-wrap: nowrap; }
    /* nodes table tuning */
    .nodes-table th, .nodes-table td { vertical-align: middle; font-size:13px; }
    .nodes-table .cell-actions{ min-width: 260px; }
    .cell-ip{ direction:ltr; white-space: nowrap; min-width:120px; }
    .cell-ip code{ overflow-wrap: normal; word-break: normal; }
    .btn-details, .btn-toggle{ min-width:84px; text-align:center; }
    td .input-inline{ flex-wrap:wrap; }
    #domainsList{ overflow-y:auto; overflow-x:hidden; }
    #domainsList table{ table-layout: fixed; }
    #domainsList th:first-child, #domainsList td:first-child{ width:70%; }
    #domainsList th:last-child, #domainsList td:last-child{ width:30%; }
    .table-sticky thead th{ position: sticky; top: 0; z-index: 2; }
  </style>
</head>
<body>
  <div class="container">
  <h1>
    <span>DNS+SNI Control UI</span>
    <span class="muted">— داشبورد مدیریت</span>
  </h1>
  <div class="row">
    <div class="card col-4">
      <h2>دامنه‌ها</h2>
      <div class="grid-2">
        <form id="addForm" class="input-inline">
          <input id="domainInput" placeholder="example.com" required />
          <button type="submit" class="btn-primary">افزودن</button>
        </form>
        
      </div>
      <div class="input-inline" style="margin-top:8px;">
        <button id="syncBtn">سینک (بامپ ورژن)</button>
      </div>
      <div class="muted">افزودن دامنه روت کافی است؛ زیر‌دامنه‌ها خودکار پوشش داده می‌شوند.</div>
      <div class="divider"></div>
      <div class="input-inline" style="margin:8px 0;">
        <input id="domainSearch" placeholder="جستجو در دامنه‌ها..." style="width:100%;" />
      </div>
      <div id="domainsList" style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:10px;">
        <table class="table-sticky" style="margin-top:0; width:100%; border-collapse:collapse;">
          <thead><tr><th>دامنه</th><th>عملیات</th></tr></thead>
          <tbody id="domainsBody"></tbody>
        </table>
      </div>
      <div class="count" id="domainsCount"></div>
    </div>

    <div class="card col-8">
      <div class="section-head">
        <h2>وضعیت سامانه</h2>
        <div class="toolbar">
          <label class="muted" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="autoRefresh" /> رفرش خودکار
          </label>
          <button id="btnRefresh">رفرش</button>
        </div>
      </div>
      <div id="cfg"></div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnSelfUpdate">آپدیت کنترلر</button>
        <button id="btnNodesUpdate">آپدیت نودها (Agent)</button>
      </div>
      <details style="margin-top:10px;">
        <summary>مدیریت نسخه Agent</summary>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="agentsTarget" placeholder="نسخه هدف" style="width:140px" />
          <button id="btnSetAgentsVersion">تنظیم نسخه هدف</button>
          <button id="btnAutoSync">همگام‌سازی خودکار</button>
          <button id="btnForceReset" style="background-color:#e74c3c; color:white;">Force Reset</button>
        </div>
      </details>
      <details style="margin-top:10px;">
        <summary>توکن داخلی (Site ↔ Controller)</summary>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="internalTokenInput" placeholder="توکن داخلی" style="min-width:260px" />
          <button id="btnSaveToken">ذخیره در مرورگر</button>
          <button id="btnClearToken" style="background-color:#444;">حذف از مرورگر</button>
          <span id="tokenStatus" class="muted"></span>
        </div>
        <div class="divider"></div>
        <div class="kv">
          <b>وضعیت توکن کنترلر</b><div id="serverTokenEnabled">—</div>
          <b>منبع</b><div id="serverTokenSource">—</div>
        </div>
        <div class="input-inline" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
          <button id="btnSetServerToken" class="btn-primary">ثبت توکن روی کنترلر</button>
          <button id="btnClearServerToken" style="background-color:#e74c3c; color:white;">حذف توکن از کنترلر</button>
          <span id="serverTokenNote" class="muted"></span>
        </div>
        <div class="muted" style="margin-top:6px;">در صورتی که متغیر محیطی INTERNAL_TOKEN تنظیم شده باشد، امکان تغییر توکن از طریق UI وجود ندارد.</div>
      </details>
      <details style="margin-top:10px;">
        <summary>تنظیمات UI (مسیر و ورود)</summary>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
          <div class="kv">
            <b>مسیر فعلی UI</b><div id="uiPathCurrent">—</div>
            <b>نیاز به ورود</b><div id="uiAuthCurrent">—</div>
          </div>
          <div class="divider"></div>
          <div class="input-inline" style="gap:8px; flex-wrap:wrap; align-items:center;">
            <input id="uiPathInput" placeholder="مثلاً example" style="min-width:200px;" />
            <button id="btnSaveUiPath">ثبت مسیر</button>
            <button id="btnOpenUi" style="background-color:#444; color:white;">باز کردن مسیر</button>
            <span class="muted">مسیر خارجی UI از <code>/{ui_path}</code> به مسیر داخلی <code>/_ui</code> نگاشت می‌شود.</span>
          </div>
          <div class="divider"></div>
          <div class="input-inline" style="gap:8px; flex-wrap:wrap; align-items:center;">
            <label><input type="checkbox" id="uiAuthEnabled" /> نیاز به ورود (Username/Password)</label>
            <input id="uiUsername" placeholder="نام کاربری" style="min-width:160px;" />
            <input id="uiPassword" type="password" placeholder="رمز عبور (برای تنظیم/تغییر)" style="min-width:200px;" />
            <button id="btnSaveUiAuth" class="btn-primary">ذخیره ورود</button>
            <button id="btnLogoutUi" style="background-color:#444; color:white;">خروج</button>
          </div>
          <div class="muted">در صورت فعال‌سازی، دسترسی به UI نیازمند ورود است و از طریق <code>/_ui/login</code> انجام می‌شود.</div>
        </div>
      </details>
      <details style="margin-top:10px;">
        <summary>اعمال محدودیت دسترسی (enforce)</summary>
        <div style="margin-top:8px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <label><input type="checkbox" id="flagDns" /> Enforce DNS</label>
          <label><input type="checkbox" id="flagProxy" /> Enforce Proxy</label>
          <button id="btnSaveFlags">ذخیره</button>
        </div>
      </details>
      <details style="margin-top:10px;">
        <summary>تنظیم ریپو و برنچ کد</summary>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="codeRepo" placeholder="https://github.com/lokidv/dns-loki.git" style="min-width:360px" />
          <input id="codeBranch" placeholder="main" style="width:140px" />
          <button id="btnSaveCode">ثبت</button>
        </div>
      </details>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card col-12">
      <h2>کلاینت‌ها</h2>
      <div class="muted">افزودن/ویرایش کلاینت‌های مجاز و محدوده‌ها</div>
      <div class="input-inline" style="margin:8px 0; gap:10px; flex-wrap:wrap;">
        <input id="clIp" placeholder="IP (IPv4/IPv6)" style="min-width:160px;" />
        <input id="clNote" placeholder="یادداشت (اختیاری)" style="min-width:200px;" />
        <label><input type="checkbox" id="clDns" checked /> DNS</label>
        <label><input type="checkbox" id="clProxy" checked /> Proxy</label>
        <button id="btnAddClient" class="btn-primary">افزودن</button>
      </div>
      <table class="table-sticky">
        <thead><tr><th>IP</th><th>Scope</th><th>یادداشت</th><th>عملیات</th></tr></thead>
        <tbody id="clients"></tbody>
      </table>
    </div>
    
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card col-12" style=" overflow:auto;">
      <h2>نودها</h2>
      <table class="table-sticky nodes-table">
        <thead>
          <tr>
            <th>IP</th>
            <th>نقش</th>
            <th>نسخه اعمال‌شده</th>
            <th>هدف</th>
            <th>وضعیت</th>
            <th>آخرین اتصال</th>
            <th>فعال</th>
            <th>جزئیات/عملیات</th>
          </tr>
        </thead>
        <tbody id="nodes"></tbody>
      </table>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card col-12">
      <h2>پروویژن پروکسی (SSH)</h2>
      <div class="muted">با وارد کردن اطلاعات اتصال، سرور به عنوان پروکسی تنظیم و Agent نصب می‌شود.</div>
      <div class="grid-2" style="margin-top:8px;">
        <div class="input-inline" style="gap:8px; flex-wrap:wrap;">
          <input id="pxIp" placeholder="IP" style="min-width:160px;" />
          <input id="pxUser" placeholder="SSH Username" style="min-width:160px;" />
          <input id="pxPass" placeholder="SSH Password (اختیاری)" type="password" style="min-width:200px;" />
          <textarea id="pxKey" placeholder="SSH Private Key (اختیاری)" rows="3" style="min-width:320px; width:100%;"></textarea>
        </div>
        <div class="input-inline" style="justify-content:flex-end; gap:8px;">
          <button id="btnProvision" class="btn-primary">Provision</button>
        </div>
      </div>
      <details style="margin-top:10px;">
        <summary>لاگ عملیات</summary>
        <pre id="provLog" style="white-space:pre-wrap; background:var(--surface-2); border:1px solid var(--border); padding:10px; border-radius:10px; max-height:260px; overflow:auto;"></pre>
      </details>
    </div>
  </div>
  </div>

<script>
function getInternalToken(){
  try { return localStorage.getItem('INTERNAL_TOKEN') || ''; } catch(e){ return ''; }
}
const api = (path, opts={}) => {
  const token = getInternalToken();
  const baseHeaders = { 'Content-Type': 'application/json' };
  if (token) {
    baseHeaders['X-Internal-Token'] = token;
    baseHeaders['Authorization'] = 'Bearer ' + token;
  }
  const merged = Object.assign({ headers: baseHeaders }, opts || {});
  if (opts && opts.headers) {
    merged.headers = Object.assign({}, baseHeaders, opts.headers);
  }
  return fetch(path, merged);
};
let APP = { cfg: null, refreshTimer: null, domainsAll: [] };

// moved from <style>: load UI settings from controller
async function loadUiSettings(){
  try{
    const r = await api('/v1/ui/settings');
    if(!r.ok) return;
    const j = await r.json();
    const currPath = (j.ui_path || 'ui').replace(/^\/+|\/+$/g,'');
    const pCur = document.getElementById('uiPathCurrent');
    const pInp = document.getElementById('uiPathInput');
    const aCur = document.getElementById('uiAuthCurrent');
    const aChk = document.getElementById('uiAuthEnabled');
    const uInp = document.getElementById('uiUsername');
    if(pCur) pCur.textContent = `/${currPath}/`;
    if(pInp) pInp.value = currPath;
    if(aCur) aCur.textContent = j.ui_auth_enabled ? 'فعال' : 'غیرفعال';
    if(aChk) aChk.checked = !!j.ui_auth_enabled;
    if(uInp) uInp.value = j.ui_username || '';
  }catch(e){ /* ignore */ }
}

// implement server token status loader
async function loadServerTokenStatus(){
  try{
    const r = await api('/v1/internal-token');
    if(!r.ok) return;
    const j = await r.json();
    const en = document.getElementById('serverTokenEnabled');
    const src = document.getElementById('serverTokenSource');
    const note = document.getElementById('serverTokenNote');
    const bSet = document.getElementById('btnSetServerToken');
    const bClr = document.getElementById('btnClearServerToken');
    if(en) en.textContent = j.enabled ? 'فعال' : 'غیرفعال';
    if(src) src.textContent = j.source || 'none';
    if(note) note.textContent = (j.source === 'env') ? 'توکن از محیط بارگذاری شده و قابل تغییر نیست.' : '';
    if(bSet) bSet.disabled = (j.can_set === false);
    if(bClr) bClr.disabled = (j.source === 'env') || !j.has_state_token;
  }catch(e){ /* ignore */ }
}

async function loadConfig(){
  const r = await api('/v1/config');
  const j = await r.json();
  APP.cfg = j;
  const el = document.getElementById('cfg');
  el.innerHTML = '';
  const dv = document.createElement('div');
  dv.innerHTML = `
    <div class="chips">
      <div class="pill">نسخه دامنه‌ها <b>${j.domains_version}</b></div>
      <div class="pill">نسخه ایجنت‌ها <b>${j.agents_version}</b></div>
      <div class="pill">DNS enforce <b>${j.enforce_dns_clients}</b></div>
      <div class="pill">Proxy enforce <b>${j.enforce_proxy_clients}</b></div>
    </div>
    <div style="margin-top:8px;">
      <div>ریپو دامنه‌ها: <code>${j.git_repo || '—'}</code> | برنچ: <code>${j.git_branch}</code></div>
      <div>ریپو کد: <code>${j.code_repo}</code> | برنچ: <code>${j.code_branch}</code></div>
    </div>
  `;
  el.appendChild(dv);
  // fill inputs
  document.getElementById('codeRepo').value = j.code_repo || '';
  document.getElementById('codeBranch').value = j.code_branch || 'main';
  const at = document.getElementById('agentsTarget');
  if(at) at.value = (j.agents_version!=null ? j.agents_version : '');
  // sync enforce toggles if present
  const fd = document.getElementById('flagDns');
  const fp = document.getElementById('flagProxy');
  if(fd) fd.checked = !!j.enforce_dns_clients;
  if(fp) fp.checked = !!j.enforce_proxy_clients;
}

function updateTokenUI(){
  const t = getInternalToken();
  const el = document.getElementById('tokenStatus');
  const inp = document.getElementById('internalTokenInput');
  if(inp) inp.value = t || '';
  if(el) el.textContent = t ? 'توکن مرورگر: ذخیره‌شده' : 'توکن مرورگر: تنظیم نشده';
}

function renderDomains(){
  const body = document.getElementById('domainsBody');
  const q = (document.getElementById('domainSearch')?.value || '').trim().toLowerCase();
  const list = q ? APP.domainsAll.filter(d => (d||'').toLowerCase().includes(q)) : APP.domainsAll.slice();
  body.innerHTML = '';
  list.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><code>${d}</code></td><td class="row-actions"><button data-d="${d}">حذف</button></td>`;
    tr.querySelector('button').onclick = async (ev) => {
      const dom = ev.target.getAttribute('data-d');
      const r = await api(`/v1/domains/${encodeURIComponent(dom)}`, { method:'DELETE' });
      if(!r.ok){ const t = await r.text(); alert('خطا در حذف دامنه: ' + t); return; }
      await loadDomains();
      await loadConfig();
    };
    body.appendChild(tr);
  });
  const cnt = document.getElementById('domainsCount');
  if(cnt){ cnt.textContent = `تعداد دامنه‌ها: ${list.length} از ${APP.domainsAll.length}`; }
}

async function loadDomains(){
  const r = await api('/v1/domains');
  APP.domainsAll = await r.json();
  renderDomains();
}

async function loadClients(){
  const r = await api('/v1/clients');
  const arr = await r.json();
  const el = document.getElementById('clients');
  el.innerHTML = '';
  arr.forEach(c => {
    const tr = document.createElement('tr');
    const hasDns = Array.isArray(c.scope) && c.scope.includes('dns');
    const hasProxy = Array.isArray(c.scope) && c.scope.includes('proxy');
    const note = c.note || '';
    tr.innerHTML = `
      <td><code>${c.ip}</code></td>
      <td>
        <div class="chips" style="gap:12px;">
          <label><input type="checkbox" class="scDns" ${hasDns?'checked':''} /> DNS</label>
          <label><input type="checkbox" class="scProxy" ${hasProxy?'checked':''} /> Proxy</label>
        </div>
      </td>
      <td><input class="clRowNote" placeholder="یادداشت" value="${note.replace(/"/g, '&quot;')}" style="min-width:200px;" /></td>
      <td class="row-actions">
        <div class="input-inline" style="gap:6px;">
          <button class="btnSave">ذخیره</button>
          <button class="btnDel" style="background-color:#e74c3c; color:white;">حذف</button>
        </div>
      </td>`;
    // delete
    tr.querySelector('.btnDel').onclick = async () => {
      const r = await api(`/v1/clients/${encodeURIComponent(c.ip)}`, { method:'DELETE' });
      if(!r.ok){ const t = await r.text(); alert('خطا در حذف کلاینت: ' + t); return; }
      await Promise.all([loadClients(), loadConfig()]);
    };
    // save (delete + add)
    tr.querySelector('.btnSave').onclick = async () => {
      const scDns = !!tr.querySelector('.scDns')?.checked;
      const scProxy = !!tr.querySelector('.scProxy')?.checked;
      const noteVal = tr.querySelector('.clRowNote')?.value || '';
      const scope = [];
      if(scDns) scope.push('dns');
      if(scProxy) scope.push('proxy');
      if(scope.length === 0){ alert('حداقل یکی از DNS یا Proxy را انتخاب کنید.'); return; }
      // delete old
      await api(`/v1/clients/${encodeURIComponent(c.ip)}`, { method:'DELETE' });
      // add new
      const body = { ip: c.ip, note: noteVal, scope };
      const r = await api('/v1/clients', { method:'POST', body: JSON.stringify(body) });
      if(!r.ok){ const t = await r.text(); alert('خطا در ذخیره کلاینت: ' + t); return; }
      await Promise.all([loadClients(), loadConfig()]);
    };
    el.appendChild(tr);
  });
}

async function loadNodes(){
  const r = await api('/v1/nodes');
  const arr = await r.json();
  const el = document.getElementById('nodes');
  el.innerHTML = '';
  const target = (APP.cfg && APP.cfg.agents_version) ? parseInt(APP.cfg.agents_version) : null;
  const now = Date.now()/1000;
  arr.forEach(n => {
    const applied = (n.agents_version_applied==null)? '-' : n.agents_version_applied;
    const ts = n.ts ? parseFloat(n.ts) : null;
    let status = '—';
    let cls = 'warn';
    if(ts){
      const age = now - ts;
      const synced = (target!=null && n.agents_version_applied==target);
      if(age>180){ cls='err'; status='قطع ارتباط'; }
      else if(synced){ cls='ok'; status='همگام'; }
      else {
        cls='warn';
        if(applied==='-'){
          status = (target!=null) ? 'نیاز به آپدیت' : 'نامشخص';
        } else {
          status = 'نیاز به آپدیت';
        }
      }
    } else { cls='warn'; status='نامشخص'; }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="cell-ip"><code>${n.ip}</code></td>
      <td><span class="pill">${n.role||'—'}</span></td>
      <td class="right">${applied}</td>
      <td class="right">${target??'—'}</td>
      <td><span class="status ${cls}">${status}</span></td>
      <td>${ts? fmtAgo(ts): '—'}</td>
      <td>${n.enabled ? '<span class="status ok">فعال</span>' : '<span class="status err">غیرفعال</span>'}</td>
      <td class="cell-actions">
        <div class="input-inline" style="gap:6px;">
          <button class="btn-details">جزئیات</button>
          <button class="btn-toggle">${n.enabled ? 'غیرفعال' : 'فعال'}</button>
          <button class="btn-del" style="background-color:#e74c3c; color:white;">حذف</button>
        </div>
      </td>
    `;
    // build details row (structured)
    const d = n.diag || {};
    const svc = d.svc || {};
    const files = d.files || {};
    const healthy = (d.proxies_healthy!=null? d.proxies_healthy : 0);
    const total = (d.proxies_total!=null? d.proxies_total : 0);
    const coreRun = svc.coredns_running===true ? '<span class="status ok">روشن</span>' : (svc.coredns_running===false ? '<span class="status err">خاموش</span>' : '—');
    const sniRun = svc.sniproxy_running===true ? '<span class="status ok">روشن</span>' : (svc.sniproxy_running===false ? '<span class="status err">خاموش</span>' : '—');
    const agentRun = (ts && (now - ts) <= 180) ? '<span class="status ok">روشن</span>' : '<span class="status err">خاموش</span>';
    const targ = files.targets_override || {};
    const snic = files.sniproxy_conf || {};
    const selLat = (d.selected_latency_ms!=null) ? (Math.round(d.selected_latency_ms) + ' ms') : null;
    let latmap = '';
    if(d.proxies_latency_ms && typeof d.proxies_latency_ms === 'object'){
      try{
        latmap = Object.entries(d.proxies_latency_ms).map(([ip,v])=> ip + ': ' + Math.round(v) + ' ms').join(', ');
      }catch(_){ latmap = ''; }
    }

    const trd = document.createElement('tr');
    trd.style.display = 'none';
    // Build allowlists/nft sets diagnostics
    const ca = d.client_allowlists || {};
    const nft = d.nft_sets || {};
    const dnsCfgArr = Array.isArray(ca.dns_clients_configured) ? ca.dns_clients_configured : [];
    const proxyCfgArr = Array.isArray(ca.proxy_clients_configured) ? ca.proxy_clients_configured : [];
    const proxyEffArr = Array.isArray(ca.proxy_effective_allowlist) ? ca.proxy_effective_allowlist : [];
    const dnsNftArr = Array.isArray(nft.allow_dns_clients) ? nft.allow_dns_clients : [];
    const proxyNftArr = Array.isArray(nft.allow_proxy_clients) ? nft.allow_proxy_clients : [];
    const dnsCfg = dnsCfgArr.join(', ');
    const proxyCfg = proxyCfgArr.join(', ');
    const proxyEff = proxyEffArr.join(', ');
    const dnsNft = dnsNftArr.join(', ');
    const proxyNft = proxyNftArr.join(', ');
    trd.innerHTML = `
      <td colspan="8">
        <div class="details">
          <div class="kv">
            <b>نقش</b><div>${d.role || n.role || '—'}</div>
            <b>تعداد دامنه‌ها</b><div>${d.domains_count ?? '—'}</div>
            <b>پروکسی سالم/کل</b><div>${healthy}/${total}</div>
            <b>پروکسی منتخب</b><div>${d.selected_proxy ? (d.selected_proxy + (selLat? ' ('+selLat+')' : '')) : '—'}</div>
            <b>Latencyها</b><div>${latmap || '—'}</div>
            <b>DNS enforce</b><div>${d.enforce_dns===true ? '<span class="status ok">فعال</span>' : '<span class="status warn">غیرفعال</span>'}</div>
            <b>Proxy enforce</b><div>${d.enforce_proxy===true ? '<span class="status ok">فعال</span>' : '<span class="status warn">غیرفعال</span>'}</div>
            <b>DNS allowlist (config)</b><div>${dnsCfg || '—'} ${dnsCfgArr.length? `<span class='pill'>${dnsCfgArr.length}</span>`:''}</div>
            <b>DNS allowlist (nft)</b><div>${dnsNft || '—'} ${dnsNftArr.length? `<span class='pill'>${dnsNftArr.length}</span>`:''}</div>
            <b>Proxy allowlist (config)</b><div>${proxyCfg || '—'} ${proxyCfgArr.length? `<span class='pill'>${proxyCfgArr.length}</span>`:''}</div>
            <b>Proxy allowlist (effective)</b><div>${proxyEff || '—'} ${proxyEffArr.length? `<span class='pill'>${proxyEffArr.length}</span>`:''}</div>
            <b>Proxy allowlist (nft)</b><div>${proxyNft || '—'} ${proxyNftArr.length? `<span class='pill'>${proxyNftArr.length}</span>`:''}</div>
            <b>Agent</b><div>${agentRun}</div>
            <b>CoreDNS</b><div>${coreRun}</div>
            <b>SNI Proxy</b><div>${sniRun}</div>
            <b>targets.override</b><div>${targ.exists? 'بله' : 'خیر'} ${targ.size? `(${targ.size} B)` : ''}</div>
            <b>sniproxy.conf</b><div>${snic.exists? 'بله' : 'خیر'} ${snic.size? `(${snic.size} B)` : ''}</div>
          </div>
          <div class="divider"></div>
          <details>
            <summary>ری‌استارت سرویس‌ها (SSH)</summary>
            <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
              <div class="grid-2">
                <input class="rsUser" placeholder="ssh user (مثلاً root)" />
                <input class="rsPass" placeholder="ssh password (اختیاری)" type="password" />
              </div>
              <textarea class="rsKey" placeholder="کلید خصوصی (اختیاری)" rows="4"></textarea>
              <div class="chips" style="gap:12px;">
                <label><input type="checkbox" class="rsAgent" checked /> Agent</label>
                <label><input type="checkbox" class="rsCoreDNS" checked /> CoreDNS</label>
                <label><input type="checkbox" class="rsSNI" checked /> SNI Proxy</label>
              </div>
              <div class="input-inline">
                <button class="btn-restart">ری‌استارت</button>
              </div>
              <pre class="rsLog" style="white-space:pre-wrap; background:var(--surface-2); border:1px solid var(--border); padding:10px; border-radius:10px; max-height:200px; overflow:auto;"></pre>
            </div>
          </details>
        </div>
      </td>
    `;
    el.appendChild(tr);
    el.appendChild(trd);
    tr.querySelector('.btn-details').onclick = () => {
      trd.style.display = (trd.style.display==='none') ? 'table-row' : 'none';
    };
    tr.querySelector('.btn-toggle').onclick = async () => {
      const ip = encodeURIComponent(n.ip);
      const path = n.enabled ? `/v1/nodes/${ip}/disable` : `/v1/nodes/${ip}/enable`;
      const r = await api(path, { method:'POST' });
      if(!r.ok){ const t = await r.text(); alert('خطا در تغییر وضعیت نود: ' + t); return; }
      await loadNodes();
    };
    // delete node
    tr.querySelector('.btn-del').onclick = async () => {
      if(!confirm('این نود حذف شود؟')) return;
      const ip = encodeURIComponent(n.ip);
      const r = await api(`/v1/nodes/${ip}`, { method:'DELETE' });
      if(!r.ok){ const t = await r.text(); alert('خطا در حذف نود: ' + t); return; }
      await loadNodes();
    };
    // restart services handler
    const btnR = trd.querySelector('.btn-restart');
    btnR.onclick = async () => {
      const ip2 = encodeURIComponent(n.ip);
      const user = (trd.querySelector('.rsUser').value || '').trim();
      const pass = trd.querySelector('.rsPass').value;
      const key = trd.querySelector('.rsKey').value;
      const sAgent = trd.querySelector('.rsAgent').checked;
      const sCore = trd.querySelector('.rsCoreDNS').checked;
      const sSni = trd.querySelector('.rsSNI').checked;
      const logEl = trd.querySelector('.rsLog');
      logEl.textContent = '';
      if(!user){ alert('Username الزامی است'); return; }
      if(!pass && !key){ alert('لطفاً یکی از password یا key را وارد کنید'); return; }
      const services = [];
      if(sAgent) services.push('agent');
      if(sCore) services.push('coredns');
      if(sSni) services.push('sniproxy');
      if(services.length===0){ alert('حداقل یک سرویس را انتخاب کنید'); return; }
      const body = { ssh_user: user, services };
      if(pass) body.ssh_password = pass;
      if(key) body.ssh_key = key;
      btnR.disabled = true; const oldTxt = btnR.textContent; btnR.textContent = 'در حال ری‌استارت...';
      try{
        const r = await api(`/v1/nodes/${ip2}/restart`, { method:'POST', body: JSON.stringify(body) });
        const txt = await r.text();
        if(!r.ok){
          logEl.textContent = txt || 'خطای نامشخص';
          alert('ری‌استارت ناموفق بود');
          return;
        }
        let j = {};
        try{ j = JSON.parse(txt); }catch(e){}
        logEl.textContent = j.log || txt || 'OK';
        // Optionally refresh node status
        await loadNodes();
      }catch(e){
        logEl.textContent = (e?.message || e);
      }finally{
        btnR.disabled = false; btnR.textContent = oldTxt;
      }
    };
  });
}

async function init(){
  await Promise.all([loadConfig(), loadDomains(), loadClients(), loadNodes(), loadServerTokenStatus(), loadUiSettings()]);
  updateTokenUI();
}

init();

// UI settings handlers (moved out of api())
document.getElementById('btnSaveUiPath')?.addEventListener('click', async () => {
  const raw = (document.getElementById('uiPathInput')?.value || '').trim();
  const v = raw.replace(/^\/+|\/+$/g, '');
  if(!v){ alert('مسیر معتبر وارد کنید (مثلاً example)'); return; }
  try{
    const r = await api('/v1/ui/settings', { method:'POST', body: JSON.stringify({ ui_path: v }) });
    const t = await r.text();
    if(!r.ok){ alert('خطا در ثبت مسیر: ' + t); return; }
    await loadUiSettings();
    alert(`ثبت شد. از این پس UI در مسیر /${v}/ در دسترس است.`);
  }catch(e){ alert('خطا: ' + (e?.message || e)); }
});

document.getElementById('btnOpenUi')?.addEventListener('click', async () => {
  try{
    const r = await api('/v1/ui/settings');
    if(!r.ok){ window.open('/ui/', '_blank'); return; }
    const j = await r.json();
    const currPath = (j.ui_path || 'ui').replace(/^\/+|\/+$/g,'');
    const url = `${location.origin}/${currPath}/`;
    window.open(url, '_blank');
  }catch(e){ window.open('/ui/', '_blank'); }
});

document.getElementById('btnSaveUiAuth')?.addEventListener('click', async () => {
  const enabled = !!document.getElementById('uiAuthEnabled')?.checked;
  const username = (document.getElementById('uiUsername')?.value || '').trim();
  const password = (document.getElementById('uiPassword')?.value || '').trim();
  const payload = { ui_auth_enabled: enabled };
  if(username) payload.ui_username = username;
  if(password) payload.ui_password = password;
  try{
    const r = await api('/v1/ui/settings', { method:'POST', body: JSON.stringify(payload) });
    const t = await r.text();
    if(!r.ok){ alert('خطا در ذخیره تنظیمات ورود: ' + t); return; }
    (document.getElementById('uiPassword')||{}).value = '';
    await loadUiSettings();
    alert('تنظیمات ورود ذخیره شد. در صورت فعال بودن، با باز کردن UI به صفحه ورود هدایت می‌شوید.');
  }catch(e){ alert('خطا: ' + (e?.message || e)); }
});

document.getElementById('btnLogoutUi')?.addEventListener('click', () => {
  location.href = '/logout';
});

// add client handler
document.getElementById('btnAddClient')?.addEventListener('click', async () => {
  const ip = (document.getElementById('clIp')?.value || '').trim();
  const note = (document.getElementById('clNote')?.value || '').trim();
  const scDns = !!document.getElementById('clDns')?.checked;
  const scProxy = !!document.getElementById('clProxy')?.checked;
  if(!ip){ alert('IP الزامی است'); return; }
  const scope = [];
  if(scDns) scope.push('dns');
  if(scProxy) scope.push('proxy');
  if(scope.length === 0){ alert('حداقل یکی از DNS یا Proxy را انتخاب کنید.'); return; }
  const body = { ip, note, scope };
  const r = await api('/v1/clients', { method:'POST', body: JSON.stringify(body) });
  if(!r.ok){ const t = await r.text(); alert('خطا در افزودن کلاینت: ' + t); return; }
  // reset inputs
  document.getElementById('clIp').value = '';
  document.getElementById('clNote').value = '';
  document.getElementById('clDns').checked = true;
  document.getElementById('clProxy').checked = true;
  await Promise.all([loadClients(), loadConfig()]);
});

// save flags handler
document.getElementById('btnSaveFlags')?.addEventListener('click', async () => {
  const enforce_dns_clients = !!document.getElementById('flagDns')?.checked;
  const enforce_proxy_clients = !!document.getElementById('flagProxy')?.checked;
  const r = await api('/v1/flags', { method:'POST', body: JSON.stringify({ enforce_dns_clients, enforce_proxy_clients }) });
  if(!r.ok){ const t = await r.text(); alert('خطا در ذخیره enforce: ' + t); return; }
  await loadConfig();
  alert('ذخیره شد.');
});

// internal token handlers
document.getElementById('btnSaveToken')?.addEventListener('click', () => {
  const v = (document.getElementById('internalTokenInput')?.value || '').trim();
  if(!v){ alert('توکن را وارد کنید'); return; }
  try { localStorage.setItem('INTERNAL_TOKEN', v); } catch(e){}
  updateTokenUI();
  // Immediately refresh server-visible state now that requests include the token
  loadServerTokenStatus();
  loadUiSettings();
  alert('توکن ذخیره شد.');
});
document.getElementById('btnClearToken')?.addEventListener('click', () => {
  try { localStorage.removeItem('INTERNAL_TOKEN'); } catch(e){}
  updateTokenUI();
  // Reflect loss of auth in server status and UI settings (may 401 internally and be ignored)
  loadServerTokenStatus();
  loadUiSettings();
  alert('توکن پاک شد.');
});

// server-side internal token actions
document.getElementById('btnSetServerToken')?.addEventListener('click', async () => {
  const v = (document.getElementById('internalTokenInput')?.value || '').trim();
  if(!v){ alert('توکن را وارد کنید'); return; }
  try{
    const r = await api('/v1/internal-token', { method:'POST', body: JSON.stringify({ token: v }) });
    const t = await r.text();
    if(!r.ok){ alert('خطا در ثبت توکن روی کنترلر: ' + t); return; }
    await loadServerTokenStatus();
    alert('توکن روی کنترلر ثبت شد.');
  }catch(e){
    alert('خطا: ' + (e?.message || e));
  }
});

document.getElementById('btnClearServerToken')?.addEventListener('click', async () => {
  if(!confirm('توکن ذخیره‌شده در کنترلر پاک شود؟')) return;
  try{
    const r = await api('/v1/internal-token', { method:'POST', body: JSON.stringify({ token: '' }) });
    const t = await r.text();
    if(!r.ok){ alert('خطا در حذف توکن کنترلر: ' + t); return; }
    await loadServerTokenStatus();
    alert('توکن کنترلر حذف شد.');
  }catch(e){
    alert('خطا: ' + (e?.message || e));
  }
});

// helpers
function fmtAgo(ts){
  const s = Math.max(0, Math.floor(Date.now()/1000 - ts));
  if(s<60) return `${s} ثانیه پیش`;
  const m = Math.floor(s/60); if(m<60) return `${m} دقیقه پیش`;
  const h = Math.floor(m/60); if(h<24) return `${h} ساعت پیش`;
  const d = Math.floor(h/24); return `${d} روز پیش`;
}

// add domain form
const addForm = document.getElementById('addForm');
addForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const dom = document.getElementById('domainInput').value.trim();
  if(!dom) return;
  const r = await api('/v1/domains/add', { method:'POST', body: JSON.stringify({domain: dom})});
  if(!r.ok){ const t = await r.text(); alert('خطا در افزودن دامنه: ' + t); return; }
  document.getElementById('domainInput').value = '';
  await loadDomains();
  await loadConfig();
});

// domain search handler
const domSearch = document.getElementById('domainSearch');
if(domSearch){ domSearch.addEventListener('input', renderDomains); }

// sync button
const syncBtn = document.getElementById('syncBtn');
syncBtn.onclick = async ()=>{
  const r = await api('/v1/domains/sync', { method:'POST' });
  if(!r.ok){ const t = await r.text(); alert('خطا در سینک: ' + t); return; }
  await loadConfig();
  await loadUiSettings();
};

// manual refresh
document.getElementById('btnRefresh').onclick = async ()=>{
  await Promise.all([loadConfig(), loadDomains(), loadClients(), loadNodes(), loadUiSettings()]);
  await loadServerTokenStatus();
};

// auto refresh toggle
document.getElementById('autoRefresh').addEventListener('change', (e)=>{
  if(e.target.checked){
    if(APP.refreshTimer) clearInterval(APP.refreshTimer);
    APP.refreshTimer = setInterval(async ()=>{
      await Promise.all([loadConfig(), loadDomains(), loadClients(), loadNodes(), loadUiSettings()]);
      await loadServerTokenStatus();
    }, 10000);
  } else {
    if(APP.refreshTimer) clearInterval(APP.refreshTimer);
    APP.refreshTimer = null;
  }
});

// save code repo/branch
document.getElementById('btnSaveCode').onclick = async ()=>{
  const repo = document.getElementById('codeRepo').value.trim();
  const branch = document.getElementById('codeBranch').value.trim() || 'main';
  const r = await api('/v1/code', { method:'POST', body: JSON.stringify({ code_repo: repo, code_branch: branch })});
  if(!r.ok){ const t = await r.text(); alert('خطا در ذخیره تنظیمات کد: ' + t); return; }
  await loadConfig();
};

// controller self-update
document.getElementById('btnSelfUpdate').onclick = async ()=>{
  try {
    const r = await api('/v1/code/self-update', { method:'POST' });
    if(!r.ok){
      const t = await r.text();
      alert('خطا در آپدیت کنترلر: ' + t);
      return;
    }
    alert('در حال ری‌استارت کنترلر... چند ثانیه صبر کنید و صفحه را رفرش کنید.');
  } catch (e) {
    alert('خطا در آپدیت کنترلر: ' + (e?.message || e));
  }
};

// nodes update trigger
document.getElementById('btnNodesUpdate').onclick = async ()=>{
  try {
    const r = await api('/v1/nodes/update', { method:'POST' });
    if(!r.ok){
      const t = await r.text();
      alert('خطا در آپدیت نودها: ' + t);
      return;
    }
    const result = await r.json();
    await loadConfig();
    await loadNodes();
    alert(`آپدیت نودها موفق: ${result.updated_nodes} نود آپدیت شد.`);
  } catch (e) {
    alert('خطا در آپدیت نودها: ' + (e?.message || e));
  }
};

// set explicit agents version
document.getElementById('btnSetAgentsVersion').onclick = async ()=>{
  const val = (document.getElementById('agentsTarget').value || '').trim();
  if(!val){ alert('لطفاً نسخه هدف را وارد کنید.'); return; }
  const num = parseInt(val, 10);
  if(isNaN(num) || num < 0){ alert('نسخه نامعتبر است.'); return; }
  const r = await api('/v1/nodes/version', { method:'POST', body: JSON.stringify({ agents_version: num })});
  if(!r.ok){ const t = await r.text(); alert('خطا در تنظیم نسخه: ' + t); return; }
  await loadConfig();
  await loadNodes();
  alert('نسخه هدف تنظیم شد.');
};

// proxy provision
document.getElementById('btnProvision').onclick = async ()=>{
  const ip = document.getElementById('pxIp').value.trim();
  const user = document.getElementById('pxUser').value.trim();
  const pass = document.getElementById('pxPass').value;
  const key = document.getElementById('pxKey').value;
  const logEl = document.getElementById('provLog');
  logEl.textContent = '';
  if(!ip || !user){ alert('IP و Username الزامی هستند'); return; }
  const body = { ip, ssh_user: user };
  if(pass) body.ssh_password = pass;
  if(key) body.ssh_key = key;
  try{
    const r = await api('/v1/proxies/provision', { method:'POST', body: JSON.stringify(body) });
    const txt = await r.text();
    if(!r.ok){
      logEl.textContent = txt || 'خطای نامشخص';
      alert('پروویژن ناموفق بود');
      return;
    }
    let j = {};
    try{ j = JSON.parse(txt); }catch(e){}
    logEl.textContent = j.log || txt || 'OK';
    await Promise.all([loadConfig(), loadNodes()]);
  }catch(e){
    logEl.textContent = (e?.message || e);
  }
};

// Force Reset all agents
document.getElementById('btnForceReset').onclick = async ()=>{
  if(!confirm('آیا مطمئن هستید که می‌خواهید همه Agent ها را reset کنید؟ این کار نسخه اعمال‌شده همه نودها را به 0 تغییر داده و نسخه هدف را افزایش می‌دهد.')){
    return;
  }
  const btn = document.getElementById('btnForceReset');
  btn.disabled = true;
  btn.textContent = 'در حال Reset...';
  try {
    const r = await api('/v1/nodes/force-reset', { method:'POST' });
    if(!r.ok){ 
      const t = await r.text(); 
      alert('خطا در Force Reset: ' + t); 
      return; 
    }
    const result = await r.json();
    await loadConfig();
    await loadNodes();
    alert(`Force Reset موفق: ${result.reset_nodes} نود reset شد. نسخه هدف جدید: ${result.agents_version}`);
  } catch(e) {
    alert('خطا در Force Reset: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Force Reset';
  }
};

// auto sync: set target (if changed) and poll until all nodes applied
document.getElementById('btnAutoSync').onclick = async ()=>{
  const btn = document.getElementById('btnAutoSync');
  const input = document.getElementById('agentsTarget');
  const val = (input.value || '').trim();
  if(!val){ alert('لطفاً نسخه هدف را وارد کنید.'); return; }
  const target = parseInt(val, 10);
  if(isNaN(target) || target < 0){ alert('نسخه نامعتبر است.'); return; }
  btn.disabled = true; btn.textContent = 'در حال همگام‌سازی...';
  try{
    // set version explicitly to ensure consistency
    let needSet = true;
    if(APP.cfg && APP.cfg.agents_version!=null){ needSet = parseInt(APP.cfg.agents_version) !== target; }
    if(needSet){
      const rr = await api('/v1/nodes/version', { method:'POST', body: JSON.stringify({ agents_version: target })});
      if(!rr.ok){ const t = await rr.text(); throw new Error('خطا در تنظیم نسخه: ' + t); }
      await loadConfig();
    }
    // poll nodes until all applied
    const deadline = Date.now() + 8 * 60 * 1000; // 8 min
    while(true){
      await Promise.all([loadNodes(), loadConfig()]);
      const r = await api('/v1/nodes');
      const nodes = await r.json();
      const now = Date.now()/1000;
      const pending = nodes.filter(n => n.agents_version_applied !== target || !n.ts || (now - parseFloat(n.ts)) > 180);
      const done = nodes.length - pending.length;
      btn.textContent = `در حال همگام‌سازی... ${done}/${nodes.length}`;
      if(pending.length === 0){
        alert('همه نودها همگام شدند.');
        break;
      }
      if(Date.now() > deadline){
        const pendIps = pending.map(n => n.ip + (n.ts? '' : ' (بدون هارتبیت)')).join(', ');
        alert('مهلت به پایان رسید. نودهای باقی‌مانده: ' + pendIps);
        break;
      }
      await new Promise(res => setTimeout(res, 7000));
    }
  } catch(e){
    alert(e?.message || e);
  } finally {
    btn.disabled = false; btn.textContent = 'همگام‌سازی خودکار';
  }
};
</script>
</body>
</html>
