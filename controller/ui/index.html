<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNS+SNI Control UI</title>
  <style>
    :root{
      --bg:#0b1020; --surface:#121833; --surface-2:#0f1530; --border:#2b355e;
      --text:#e7ecff; --muted:#a8b3d0; --brand:#5c7cff; --ok:#67e08c; --warn:#ffcf66; --err:#ff7b7b;
    }
    *{ box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:var(--bg); color:var(--text); }
    .container{ max-width:1200px; margin: 24px auto; padding: 0 16px; }
    h1{ margin: 0 0 16px 0; font-size: 22px; display:flex; align-items:center; gap:10px; }
    h2{ margin: 0 0 12px 0; font-size: 18px; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: span 12; }
    @media (max-width: 900px){ .col-6, .col-4, .col-8 { grid-column: span 12; } }
    .card { background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:1px solid var(--border); border-radius:12px; padding:16px; backdrop-filter: blur(6px); }
    input, button, select, textarea { background:var(--surface-2); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    button { cursor:pointer; transition:.2s; }
    button:hover{ border-color: var(--brand); box-shadow: 0 0 0 2px rgba(92,124,255,.15) inset; }
    .btn-primary{ background: linear-gradient(180deg, #6d86ff, #4864ff); border-color: #4864ff; color:#fff; }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--border); padding:8px 10px; font-size: 14px; }
    th{ color:var(--muted); font-weight:600; text-align:right; background: rgba(255,255,255,0.02); }
    code { background:var(--surface-2); padding:2px 6px; border-radius:6px; }
    .muted { color:var(--muted); font-size:13px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; background:#1a2659; margin-left:6px; font-size:12px; }
    .status{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; font-size:12px; }
    .status.ok{ background: rgba(103,224,140,.12); color: var(--ok); border:1px solid rgba(103,224,140,.35) }
    .status.warn{ background: rgba(255,207,102,.12); color: var(--warn); border:1px solid rgba(255,207,102,.35) }
    .status.err{ background: rgba(255,123,123,.12); color: var(--err); border:1px solid rgba(255,123,123,.35) }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:700px){ .grid-2{ grid-template-columns:1fr; } }
    .right { text-align:right; }
    .left { text-align:left; }
    .section-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    .input-inline{ display:flex; gap:8px; }
    .divider{ height:1px; background: var(--border); margin: 10px 0; }
    .count{ font-size:12px; color:var(--muted); }
    .details{ background: var(--surface-2); border:1px solid var(--border); border-radius:10px; padding:10px; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; font-size:13px; }
    .kv b{ color:var(--muted); font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
  <h1>
    <span>DNS+SNI Control UI</span>
    <span class="muted">— داشبورد مدیریت</span>
  </h1>
  <div class="row">
    <div class="card col-4">
      <h2>دامنه‌ها</h2>
      <div class="grid-2">
        <form id="addForm" class="input-inline">
          <input id="domainInput" placeholder="example.com" required />
          <button type="submit" class="btn-primary">افزودن</button>
        </form>
        <div class="input-inline" style="justify-content:flex-end;">
          <button id="syncBtn">سینک (بامپ ورژن)</button>
        </div>
      </div>
      <div class="muted">افزودن دامنه روت کافی است؛ زیر‌دامنه‌ها خودکار پوشش داده می‌شوند.</div>
      <div class="divider"></div>
      <table style="margin-top:10px">
        <thead><tr><th>دامنه</th><th>عملیات</th></tr></thead>
        <tbody id="domainsBody"></tbody>
      </table>
      <div class="count" id="domainsCount"></div>
    </div>

    <div class="card col-8">
      <div class="section-head">
        <h2>وضعیت سامانه</h2>
        <div class="toolbar">
          <label class="muted" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="autoRefresh" /> رفرش خودکار
          </label>
          <button id="btnRefresh">رفرش</button>
        </div>
      </div>
      <div id="cfg"></div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnSelfUpdate">آپدیت کنترلر</button>
        <button id="btnNodesUpdate">آپدیت نودها (Agent)</button>
      </div>
      <details style="margin-top:10px;">
        <summary>تنظیم ریپو و برنچ کد</summary>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="codeRepo" placeholder="https://github.com/lokidv/dns-loki.git" style="min-width:360px" />
          <input id="codeBranch" placeholder="main" style="width:140px" />
          <button id="btnSaveCode">ثبت</button>
        </div>
      </details>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card col-6">
      <h2>کلاینت‌ها</h2>
      <div class="muted">لیست کلاینت‌های مجاز و محدوده‌ها</div>
      <table>
        <thead><tr><th>IP</th><th>Scope</th></tr></thead>
        <tbody id="clients"></tbody>
      </table>
    </div>
    <div class="card col-6">
      <h2>نودها</h2>
      <table>
        <thead>
          <tr>
            <th>IP</th>
            <th>نقش</th>
            <th>نسخه اعمال‌شده</th>
            <th>هدف</th>
            <th>وضعیت</th>
            <th>آخرین اتصال</th>
            <th>فعال</th>
            <th>جزئیات/عملیات</th>
          </tr>
        </thead>
        <tbody id="nodes"></tbody>
      </table>
    </div>
  </div>
  </div>

<script>
const api = (path, opts={}) => fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
let APP = { cfg: null, refreshTimer: null };

async function loadConfig(){
  const r = await api('/v1/config');
  const j = await r.json();
  APP.cfg = j;
  const el = document.getElementById('cfg');
  el.innerHTML = '';
  const dv = document.createElement('div');
  dv.innerHTML = `
    <div class="chips">
      <div class="pill">نسخه دامنه‌ها <b>${j.domains_version}</b></div>
      <div class="pill">نسخه ایجنت‌ها <b>${j.agents_version}</b></div>
      <div class="pill">DNS enforce <b>${j.enforce_dns_clients}</b></div>
      <div class="pill">Proxy enforce <b>${j.enforce_proxy_clients}</b></div>
    </div>
    <div style="margin-top:8px;">
      <div>ریپو دامنه‌ها: <code>${j.git_repo || '—'}</code> | برنچ: <code>${j.git_branch}</code></div>
      <div>ریپو کد: <code>${j.code_repo}</code> | برنچ: <code>${j.code_branch}</code></div>
    </div>
  `;
  el.appendChild(dv);
  // fill inputs
  document.getElementById('codeRepo').value = j.code_repo || '';
  document.getElementById('codeBranch').value = j.code_branch || 'main';
}

async function loadDomains(){
  const r = await api('/v1/domains');
  const arr = await r.json();
  const body = document.getElementById('domainsBody');
  body.innerHTML = '';
  arr.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><code>${d}</code></td><td class="row-actions"><button data-d="${d}">حذف</button></td>`;
    tr.querySelector('button').onclick = async (ev) => {
      const dom = ev.target.getAttribute('data-d');
      const r = await api(`/v1/domains/${encodeURIComponent(dom)}`, { method:'DELETE' });
      if(!r.ok){ const t = await r.text(); alert('خطا در حذف دامنه: ' + t); return; }
      await loadDomains();
      await loadConfig();
    };
    body.appendChild(tr);
  });
  document.getElementById('domainsCount').textContent = `تعداد دامنه‌ها: ${arr.length}`;
}

async function loadClients(){
  const r = await api('/v1/clients');
  const arr = await r.json();
  const el = document.getElementById('clients');
  el.innerHTML = '';
  arr.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><code>${c.ip}</code></td><td><span class="muted">${(c.scope||[]).join(', ')}</span></td>`;
    el.appendChild(tr);
  });
}

async function loadNodes(){
  const r = await api('/v1/nodes');
  const arr = await r.json();
  const el = document.getElementById('nodes');
  el.innerHTML = '';
  const target = (APP.cfg && APP.cfg.agents_version) ? parseInt(APP.cfg.agents_version) : null;
  const now = Date.now()/1000;
  arr.forEach(n => {
    const applied = (n.agents_version_applied==null)? '-' : n.agents_version_applied;
    const ts = n.ts ? parseFloat(n.ts) : null;
    let status = '—';
    let cls = 'warn';
    if(ts){
      const age = now - ts;
      const synced = (target!=null && n.agents_version_applied==target);
      if(age>180){ cls='err'; status='قطع ارتباط'; }
      else if(synced){ cls='ok'; status='همگام'; }
      else { cls='warn'; status = (applied==='-')? 'نامشخص' : 'نیاز به آپدیت'; }
    } else { cls='warn'; status='نامشخص'; }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><code>${n.ip}</code></td>
      <td><span class="pill">${n.role||'—'}</span></td>
      <td class="right">${applied}</td>
      <td class="right">${target??'—'}</td>
      <td><span class="status ${cls}">${status}</span></td>
      <td>${ts? fmtAgo(ts): '—'}</td>
      <td>${n.enabled ? '<span class="status ok">فعال</span>' : '<span class="status err">غیرفعال</span>'}</td>
      <td>
        <div class="input-inline" style="gap:6px;">
          <button class="btn-details">جزئیات</button>
          <button class="btn-toggle">${n.enabled ? 'غیرفعال' : 'فعال'}</button>
        </div>
      </td>
    `;
    // build details row (structured)
    const d = n.diag || {};
    const svc = d.svc || {};
    const files = d.files || {};
    const healthy = (d.proxies_healthy!=null? d.proxies_healthy : 0);
    const total = (d.proxies_total!=null? d.proxies_total : 0);
    const coreRun = svc.coredns_running===true ? '<span class="status ok">روشن</span>' : (svc.coredns_running===false ? '<span class="status err">خاموش</span>' : '—');
    const sniRun = svc.sniproxy_running===true ? '<span class="status ok">روشن</span>' : (svc.sniproxy_running===false ? '<span class="status err">خاموش</span>' : '—');
    const targ = files.targets_override || {};
    const snic = files.sniproxy_conf || {};

    const trd = document.createElement('tr');
    trd.style.display = 'none';
    trd.innerHTML = `
      <td colspan="8">
        <div class="details">
          <div class="kv">
            <b>نقش</b><div>${d.role || n.role || '—'}</div>
            <b>تعداد دامنه‌ها</b><div>${d.domains_count ?? '—'}</div>
            <b>پروکسی سالم/کل</b><div>${healthy}/${total}</div>
            <b>DNS enforce</b><div>${d.enforce_dns===true ? '<span class="status ok">فعال</span>' : '<span class="status warn">غیرفعال</span>'}</div>
            <b>Proxy enforce</b><div>${d.enforce_proxy===true ? '<span class="status ok">فعال</span>' : '<span class="status warn">غیرفعال</span>'}</div>
            <b>CoreDNS</b><div>${coreRun}</div>
            <b>SNI Proxy</b><div>${sniRun}</div>
            <b>targets.override</b><div>${targ.exists? 'بله' : 'خیر'} ${targ.size? `(${targ.size} B)` : ''}</div>
            <b>sniproxy.conf</b><div>${snic.exists? 'بله' : 'خیر'} ${snic.size? `(${snic.size} B)` : ''}</div>
          </div>
        </div>
      </td>
    `;
    el.appendChild(tr);
    el.appendChild(trd);
    tr.querySelector('.btn-details').onclick = () => {
      trd.style.display = (trd.style.display==='none') ? 'table-row' : 'none';
    };
    tr.querySelector('.btn-toggle').onclick = async () => {
      const ip = encodeURIComponent(n.ip);
      const path = n.enabled ? `/v1/nodes/${ip}/disable` : `/v1/nodes/${ip}/enable`;
      const r = await api(path, { method:'POST' });
      if(!r.ok){ const t = await r.text(); alert('خطا در تغییر وضعیت نود: ' + t); return; }
      await loadNodes();
    };
  });
}

async function init(){
  await Promise.all([loadConfig(), loadDomains(), loadClients(), loadNodes()]);
}

init();

// helpers
function fmtAgo(ts){
  const s = Math.max(0, Math.floor(Date.now()/1000 - ts));
  if(s<60) return `${s} ثانیه پیش`;
  const m = Math.floor(s/60); if(m<60) return `${m} دقیقه پیش`;
  const h = Math.floor(m/60); if(h<24) return `${h} ساعت پیش`;
  const d = Math.floor(h/24); return `${d} روز پیش`;
}

// add domain form
const addForm = document.getElementById('addForm');
addForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const dom = document.getElementById('domainInput').value.trim();
  if(!dom) return;
  const r = await api('/v1/domains/add', { method:'POST', body: JSON.stringify({domain: dom})});
  if(!r.ok){ const t = await r.text(); alert('خطا در افزودن دامنه: ' + t); return; }
  document.getElementById('domainInput').value = '';
  await loadDomains();
  await loadConfig();
});

// sync button
const syncBtn = document.getElementById('syncBtn');
syncBtn.onclick = async ()=>{
  const r = await api('/v1/domains/sync', { method:'POST' });
  if(!r.ok){ const t = await r.text(); alert('خطا در سینک: ' + t); return; }
  await loadConfig();
};

// manual refresh
document.getElementById('btnRefresh').onclick = async ()=>{
  await Promise.all([loadConfig(), loadDomains(), loadClients(), loadNodes()]);
};

// auto refresh toggle
document.getElementById('autoRefresh').addEventListener('change', (e)=>{
  if(e.target.checked){
    if(APP.refreshTimer) clearInterval(APP.refreshTimer);
    APP.refreshTimer = setInterval(async ()=>{
      await Promise.all([loadConfig(), loadDomains(), loadClients(), loadNodes()]);
    }, 10000);
  } else {
    if(APP.refreshTimer) clearInterval(APP.refreshTimer);
    APP.refreshTimer = null;
  }
});

// save code repo/branch
document.getElementById('btnSaveCode').onclick = async ()=>{
  const repo = document.getElementById('codeRepo').value.trim();
  const branch = document.getElementById('codeBranch').value.trim() || 'main';
  const r = await api('/v1/code', { method:'POST', body: JSON.stringify({ code_repo: repo, code_branch: branch })});
  if(!r.ok){ const t = await r.text(); alert('خطا در ذخیره تنظیمات کد: ' + t); return; }
  await loadConfig();
};

// controller self-update
document.getElementById('btnSelfUpdate').onclick = async ()=>{
  try {
    const r = await api('/v1/code/self-update', { method:'POST' });
    if(!r.ok){
      const t = await r.text();
      alert('خطا در آپدیت کنترلر: ' + t);
      return;
    }
    alert('در حال ری‌استارت کنترلر... چند ثانیه صبر کنید و صفحه را رفرش کنید.');
  } catch (e) {
    alert('خطا در آپدیت کنترلر: ' + (e?.message || e));
  }
};

// nodes update trigger
document.getElementById('btnNodesUpdate').onclick = async ()=>{
  try {
    const r = await api('/v1/nodes/update', { method:'POST' });
    if(!r.ok){
      const t = await r.text();
      alert('خطا در آپدیت نودها: ' + t);
      return;
    }
    await loadConfig();
    alert('سیگنال آپدیت ایجنت‌ها ارسال شد.');
  } catch (e) {
    alert('خطا در آپدیت نودها: ' + (e?.message || e));
  }
};
</script>
</body>
</html>
